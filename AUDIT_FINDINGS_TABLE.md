
# Audit Findings Report

| ID  | Severità | Descrizione                                                                                             | Evidenza                                                                                                                                                                                          | Raccomandazione                                                                                                                                 |
|:----|:---------|:--------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------|
| 4   | **CRITICAL** | **Mancanza di Tracciabilità E2E (Database)**: Nessuna colonna `trace_id` esiste nelle tabelle principali. | `audit_trace.py` simula la query commentando "Campo trace_id non trovato". L'analisi degli script SQL conferma l'assenza della colonna in `tasks`, `workspaces`, `asset_artifacts`, etc.        | **Priorità 1:** Aggiungere una colonna `trace_id` (nullable) a tutte le tabelle transazionali chiave. Popolarla tramite un middleware centralizzato. |
| 3   | **HIGH**     | **Incoerenze nei Prefissi API**: Endpoint duplicati con e senza il prefisso `/api`.                       | `main.py`: `director_router` montato due volte; presenza di router `_direct` e `_compat`; workaround manuali per aggiungere il prefisso `/api`.                                                    | Standardizzare un unico prefisso (`/api/v1`) per tutte le rotte. Rimuovere i router duplicati e di compatibilità.                                |
| 1   | **HIGH**     | **Duplicazione Definizioni Schema DB**: Le tabelle `tasks` e `agent_handoffs` sono definite due volte.     | `supabase_setup.sql`, righe 44-54 vs 194-211 per `tasks`.                                                                                                                                          | Consolidare ogni definizione di tabella in un'unica istruzione `CREATE TABLE` canonica, rimuovendo le versioni obsolete.                         |
| 2   | **HIGH**     | **Orchestratori Multipli**: Coesistenza di `workflow_orchestrator.py` e altri, creando confusione.        | File `backend/workflow_orchestrator.py` presente; `AUDIT_REPORT_FINAL.md` menziona altri orchestratori.                                                                                             | Scegliere un singolo orchestratore, migrare la logica necessaria e rimuovere le implementazioni deprecate.                                    |
| 4.1 | **HIGH**     | **Frammentazione del Logging**: I log sono sparsi tra tabelle DB (`execution_logs`, `thinking_steps`) e file. | `analyze_logs.py` e `audit_scripts.py` interrogano tabelle multiple. La definizione di `execution_logs` non è nel file di setup principale.                                                      | Unificare il logging in una singola tabella strutturata (o servizio di logging) con colonne standard: `trace_id`, `timestamp`, `component`, `level`, `message`. |
| 6   | **MEDIUM**   | **Mancanza di Vincoli di Univocità**: Non è possibile prevenire task o agenti con lo stesso nome.          | `supabase_setup.sql`: Nessun vincolo `UNIQUE` su `(workspace_id, name)` per le tabelle `tasks` o `agents`.                                                                                             | Introdurre vincoli `UNIQUE` a livello di database dove la logica di business lo richiede per garantire l'integrità dei dati.                     |
| 5   | **LOW**      | **Duplicazione degli Script di Test**: 9 script di test E2E con nomi e scopi potenzialmente sovrapposti. | Output del comando `glob "backend/*e2e*.py"`.                                                                                                                                                   | Consolidare i test in un unico script E2E parametrizzato o documentare chiaramente lo scopo specifico di ciascuno per ridurre la manutenzione. |

---

# Checklist Pilastri Sinergia

| Pilastro Chiave                               | Stato | Note                                                                                                                                 |
|:----------------------------------------------|:-----:|:-------------------------------------------------------------------------------------------------------------------------------------|
| **1. Sinergico (Tracciabilità E2E)**          |   ❌   | **FALLITO:** La mancanza della colonna `trace_id` nel DB interrompe la catena di audit. La tracciabilità non è verificabile.             |
| **2. Senza Duplicati (Dati Integri)**         |   ❌   | **FALLITO:** Mancano vincoli `UNIQUE` per prevenire duplicati (es. task). Lo schema stesso presenta definizioni di tabelle duplicate. |
| **3. Orchestrato (Contesto Integro)**         |   ⚠️   | **A RISCHIO:** La presenza di più orchestratori e prefissi API inconsistenti mette a rischio l'integrità del contesto applicativo. |

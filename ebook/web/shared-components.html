<!--
ðŸš€ Shared Components Include File
This file contains global components that can be included in all ebook pages.
Safe, modular, and compatible with existing designs.

Usage: Include this in any page with:
<script>
// Load shared components
fetch('/shared-components.html')
  .then(response => response.text())
  .then(html => {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    // Extract and inject CSS
    const style = tempDiv.querySelector('#shared-styles');
    if (style) document.head.appendChild(style);
    
    // Extract and inject JS
    const script = tempDiv.querySelector('#shared-scripts');
    if (script) document.head.appendChild(script);
  });
</script>

Or more simply with a direct include script (see shared-loader.js)
-->

<!-- Shared CSS Styles -->
<style id="shared-styles">
/**
 * ðŸŽ¯ Shared Lead Generation Styles
 * Universal popup styles for all ebook pages
 */

/* Lead Popup Overlay */
.lead-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(30, 27, 75, 0.85);
    backdrop-filter: blur(5px);
    z-index: 20000;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease-out;
}

.lead-popup-overlay.visible {
    display: flex;
    opacity: 1;
}

.lead-popup-content {
    background: #ffffff;
    border-radius: 20px;
    padding: 2.5rem;
    max-width: 500px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 60px rgba(76, 29, 149, 0.4);
    border: 2px solid #d97706;
    transform: translateY(30px);
    transition: transform 0.4s ease-out;
}

.lead-popup-overlay.visible .lead-popup-content {
    transform: translateY(0);
}

.lead-popup-header {
    text-align: center;
    margin-bottom: 2rem;
    border-bottom: 2px solid #d97706;
    padding-bottom: 1.5rem;
}

.popup-emoji {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
}

.popup-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    color: #4c1d95;
    margin: 0;
    font-weight: 700;
}

.lead-popup-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 2rem;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.lead-popup-close:hover {
    color: #4c1d95;
    background: rgba(76, 29, 149, 0.1);
}

.lead-popup-body p {
    font-size: 1rem;
    color: #374151;
    margin-bottom: 1.5rem;
    line-height: 1.6;
    text-align: left;
}

.lead-popup-body p:first-child {
    text-align: center;
}

#lead-form .form-group {
    margin-bottom: 1.5rem;
}

#lead-form label {
    display: block;
    font-weight: 600;
    color: #4c1d95;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

#lead-form input[type="text"],
#lead-form input[type="email"],
#lead-form select,
#lead-form textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid rgba(76, 29, 149, 0.2);
    border-radius: 8px;
    font-size: 1rem;
    background: #ffffff;
    transition: all 0.3s ease;
    font-family: inherit;
    box-sizing: border-box;
}

#lead-form input[type="text"]:focus,
#lead-form input[type="email"]:focus,
#lead-form select:focus,
#lead-form textarea:focus {
    outline: none;
    border-color: #d97706;
    box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.15);
}

#lead-form textarea {
    resize: vertical;
    min-height: 80px;
}

.checkbox-group {
    margin-bottom: 1.5rem;
}

.checkbox-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    font-size: 0.9rem;
    line-height: 1.5;
    color: #374151;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
    margin-right: 0.75rem;
    margin-top: 0.25rem;
    flex-shrink: 0;
}

.lead-submit-btn {
    background: linear-gradient(135deg, #d97706, #f59e0b);
    color: #ffffff;
    border: none;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
    width: 100%;
    margin-top: 1rem;
}

.lead-submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(217, 119, 6, 0.4);
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.lead-submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.success-message {
    text-align: center;
    padding: 1rem 0;
}

.success-message h4 {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    color: #059669;
    margin-bottom: 1rem;
}

.success-message p {
    font-size: 1.1rem;
    color: #374151;
    margin-bottom: 1.5rem;
}

.popup-footer {
    text-align: center;
    margin-top: 1rem;
    font-size: 0.75rem;
    color: #9ca3af;
    opacity: 0.7;
}

/* Responsive */
@media (max-width: 768px) {
    .lead-popup-content {
        padding: 2rem;
        margin: 1rem;
        border-radius: 15px;
    }
    
    .popup-title {
        font-size: 1.5rem;
    }
    
    .lead-popup-body p {
        font-size: 0.95rem;
    }
}

/* Print Styles - Hide during PDF generation */
@media print {
    .lead-popup-overlay {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
}
</style>

<!-- Shared JavaScript -->
<script id="shared-scripts">
/**
 * ðŸŽ¯ Shared Lead Generation System
 * Universal lead generation popup for all ebook pages
 */

// Only initialize if not already done
if (!window.SharedComponentsLoaded) {
    window.SharedComponentsLoaded = true;

    // Configuration
    window.LeadGenConfig = {
        apiUrl: 'https://hook.eu2.make.com/your-webhook-url', // Replace with actual webhook
        triggers: {
            scrollDepth: 50,
            timeOnPage: 240,
            exitIntent: true,
            mobileScrollStop: 6000,
            returnVisitor: 10000
        },
        debug: false
    };

    // State
    let leadPopupState = {
        shown: false,
        triggers: {
            scrollDepth: false,
            timeOnPage: false,
            exitIntent: false,
            mobileScrollStop: false,
            returnVisitor: false
        },
        timeOnPage: 0
    };

    function debugLog(message, ...args) {
        if (window.LeadGenConfig.debug) {
            console.log(`ðŸŽ¯ LeadGen: ${message}`, ...args);
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function shouldShowPopup() {
        if (sessionStorage.getItem('leadPopupShown') === 'true' || 
            localStorage.getItem('leadPopupShown') === 'true') {
            return false;
        }
        return !leadPopupState.shown;
    }

    function showLeadPopup(trigger = 'manual') {
        if (!shouldShowPopup()) {
            debugLog(`Popup blocked - already shown. Trigger: ${trigger}`);
            return;
        }

        debugLog(`Showing popup with trigger: ${trigger}`);

        leadPopupState.shown = true;
        sessionStorage.setItem('leadPopupShown', 'true');
        sessionStorage.setItem('leadPopupTrigger', trigger);

        const popupHTML = `
            <div id="lead-popup-overlay" class="lead-popup-overlay">
                <div class="lead-popup-content">
                    <button class="lead-popup-close" onclick="closeLeadPopup()">&times;</button>
                    
                    <div class="lead-popup-header">
                        <span class="popup-emoji">ðŸ“§</span>
                        <h3 class="popup-title">Get Free Updates</h3>
                    </div>
                    
                    <div class="lead-popup-body">
                        <p><strong>No spam promise!</strong> ðŸ˜Š</p>
                        <p>I'm curious to know <strong>who's reading</strong> this guide. Help me understand if I'm going in the right direction!</p>
                        <p>In return, I'll send you <strong>updates</strong> when I publish new content.</p>
                        
                        <form id="lead-form" onsubmit="submitLeadForm(event)">
                            <div class="form-group">
                                <label for="lead-name">Name *</label>
                                <input type="text" id="lead-name" name="name" required placeholder="Your name">
                            </div>
                            
                            <div class="form-group">
                                <label for="lead-email">Email *</label>
                                <input type="email" id="lead-email" name="email" required placeholder="your@email.com">
                            </div>
                            
                            <div class="form-group">
                                <label for="lead-role">Your Role</label>
                                <select id="lead-role" name="role">
                                    <option value="">Select (optional)</option>
                                    <option value="ceo">CEO/Founder</option>
                                    <option value="cto">CTO/Tech Lead</option>
                                    <option value="developer">Developer</option>
                                    <option value="product-manager">Product Manager</option>
                                    <option value="consultant">Consultant</option>
                                    <option value="student">Student</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="gdpr-consent" name="gdpr_consent" required>
                                <label for="gdpr-consent" class="checkbox-label">
                                    I consent to receive updates about AI content. You can unsubscribe anytime.
                                </label>
                            </div>
                            
                            <button type="submit" class="lead-submit-btn">Get Free Updates</button>
                            <p class="popup-footer">Trigger: ${trigger}</p>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', popupHTML);
        
        setTimeout(() => {
            const overlay = document.getElementById('lead-popup-overlay');
            if (overlay) {
                overlay.classList.add('visible');
            }
        }, 100);
    }

    function closeLeadPopup() {
        const overlay = document.getElementById('lead-popup-overlay');
        if (overlay) {
            overlay.classList.remove('visible');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
        debugLog('Popup closed by user');
    }

    function submitLeadForm(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const trigger = sessionStorage.getItem('leadPopupTrigger') || 'unknown';
        
        const data = {
            name: formData.get('name'),
            email: formData.get('email'),
            role: formData.get('role') || 'not-specified',
            gdpr_consent: formData.get('gdpr_consent') === 'on',
            trigger: trigger,
            page_url: window.location.href,
            page_title: document.title,
            timestamp: new Date().toISOString()
        };

        debugLog('Submitting lead form', data);

        const submitBtn = document.querySelector('.lead-submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Saving...';
        submitBtn.disabled = true;

        // Simulated submission (replace with actual API call)
        setTimeout(() => {
            debugLog('Lead form submitted successfully (simulated)');
            showSuccessMessage();
            localStorage.setItem('leadPopupShown', 'true');
        }, 1000);

        // TODO: Implement actual API submission
        /*
        fetch(window.LeadGenConfig.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(response => {
            if (response.ok) {
                showSuccessMessage();
                localStorage.setItem('leadPopupShown', 'true');
            } else {
                throw new Error('Network response was not ok');
            }
        }).catch(error => {
            debugLog('Submission failed', error);
            alert('Something went wrong. Please try again.');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
        */
    }

    function showSuccessMessage() {
        const form = document.getElementById('lead-form');
        if (form) {
            form.innerHTML = `
                <div class="success-message">
                    <h4>ðŸŽ‰ Thank you!</h4>
                    <p>You're all set! I'll send you updates when new content is available.</p>
                    <button onclick="closeLeadPopup()" class="lead-submit-btn">Continue Reading</button>
                </div>
            `;
        }
    }

    function initLeadGeneration() {
        if (!shouldShowPopup()) {
            debugLog('Lead popup already shown, skipping initialization');
            return;
        }

        debugLog('Initializing lead generation system');

        // Track visit count
        let visitCount = parseInt(localStorage.getItem('ebook-visit-count') || '0');
        visitCount++;
        localStorage.setItem('ebook-visit-count', visitCount.toString());

        // Initialize triggers
        initScrollDepthTrigger();
        initTimeOnPageTrigger();
        initExitIntentTrigger();

        // Return visitor trigger
        if (visitCount > 1) {
            setTimeout(() => {
                if (shouldShowPopup()) {
                    showLeadPopup('return-visitor');
                }
            }, window.LeadGenConfig.triggers.returnVisitor);
        }
    }

    function initScrollDepthTrigger() {
        const scrollHandler = debounce(() => {
            if (leadPopupState.triggers.scrollDepth || !shouldShowPopup()) return;

            const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
            
            if (scrollPercent >= window.LeadGenConfig.triggers.scrollDepth) {
                leadPopupState.triggers.scrollDepth = true;
                setTimeout(() => {
                    if (shouldShowPopup()) {
                        showLeadPopup('scroll-depth');
                    }
                }, 2000);
            }
        }, 1000);

        window.addEventListener('scroll', scrollHandler);
    }

    function initTimeOnPageTrigger() {
        const timeTracker = setInterval(() => {
            leadPopupState.timeOnPage += 30;
            
            if (leadPopupState.timeOnPage >= window.LeadGenConfig.triggers.timeOnPage && 
                !leadPopupState.triggers.timeOnPage && shouldShowPopup()) {
                
                leadPopupState.triggers.timeOnPage = true;
                showLeadPopup('time-on-page');
                clearInterval(timeTracker);
            }

            if (leadPopupState.shown) {
                clearInterval(timeTracker);
            }
        }, 30000);
    }

    function initExitIntentTrigger() {
        let exitIntentShown = false;

        document.addEventListener('mouseleave', (e) => {
            if (e.clientY <= 0 && !leadPopupState.triggers.exitIntent && 
                shouldShowPopup() && !exitIntentShown) {
                
                exitIntentShown = true;
                leadPopupState.triggers.exitIntent = true;
                showLeadPopup('exit-intent');
            }
        });
    }

    // Global functions
    window.showLeadPopup = showLeadPopup;
    window.closeLeadPopup = closeLeadPopup;
    window.submitLeadForm = submitLeadForm;

    // Auto-initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLeadGeneration);
    } else {
        initLeadGeneration();
    }
}
</script>
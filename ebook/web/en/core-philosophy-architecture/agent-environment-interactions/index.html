<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Agent and Its Environment: Designing Fundamental Interactions | Core Philosophy Architecture | AI Team Orchestrator</title>
    <meta name="description" content="Chapter 6 of AI Team Orchestrator: The Agent and Its Environment - Designing Fundamental Interactions">
    <meta name="robots" content="index, follow">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🤖</text></svg>">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .chapter-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .chapter-instrument {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .chapter-meta {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            flex-wrap: wrap;
        }
        
        .chapter-title {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .chapter-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #34495e;
        }
        
        .chapter-content h3 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin: 2.5rem 0 1.5rem 0;
            font-weight: 700;
        }
        
        .chapter-content p {
            margin-bottom: 1.5rem;
        }
        
        .chapter-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }
        
        .chapter-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }
        
        .chapter-content pre code {
            background: none;
            padding: 0;
            color: #212529;
        }
        
        .chapter-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .chapter-content th,
        .chapter-content td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .chapter-content th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .chapter-content ul, .chapter-content ol {
            margin: 1.5rem 0;
            padding-left: 2rem;
        }
        
        .chapter-content li {
            margin-bottom: 0.5rem;
        }
        
        .key-takeaways-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
        }
        
        .key-takeaways-title {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }
        
        .takeaway-item {
            margin: 1rem 0;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .takeaway-item:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #4ade80;
            font-weight: bold;
        }
        
        .war-story-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }
        
        .war-story-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .war-story-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
        
        .war-story-header h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: #92400e;
        }
        
        .war-story-content {
            color: #92400e;
        }
        
        .architecture-section {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            border-left: 4px solid #0277bd;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }
        
        .architecture-title {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .architecture-icon {
            width: 24px;
            height: 24px;
            margin-right: 0.5rem;
            color: #0277bd;
        }
        
        .architecture-title h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: #0277bd;
        }
        
        .mermaid {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .breadcrumb {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb span {
            color: #7f8c8d;
            margin: 0 0.5rem;
        }
        
        .chapter-nav-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            gap: 2rem;
        }
        
        .nav-section {
            flex: 1;
            text-align: center;
        }
        
        .nav-section.center {
            border-left: 1px solid #e9ecef;
            border-right: 1px solid #e9ecef;
        }
        
        .nav-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }
        
        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: inline-block;
        }
        
        .nav-link:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Reader Tools */
        .reader-tools {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            transition: all 0.3s ease;
            min-width: 60px;
        }
        
        .reader-tool {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #667eea;
            font-weight: 500;
        }
        
        .reader-tool:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .reader-tool-icon {
            font-size: 1.2rem;
            min-width: 20px;
        }
        
        .reader-tool-label {
            font-size: 0.9rem;
        }
        
        .language-select {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.5rem;
            color: #667eea;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .language-select:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        /* Reading Progress */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(102, 126, 234, 0.2);
            z-index: 1001;
        }
        
        .reading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.2s ease;
            width: 0%;
        }
        
        /* Bookmark Toast */
        .bookmark-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4ade80;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1002;
        }
        
        .bookmark-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .bookmark-toast.error {
            background: #ef4444;
        }
        
        /* Dark Mode */
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e9ecef;
        }
        
        .dark-mode .container {
            background: rgba(26, 26, 46, 0.95);
            color: #e9ecef;
        }
        
        .dark-mode .chapter-title,
        .dark-mode .chapter-content h3 {
            color: #e9ecef;
        }
        
        .dark-mode .chapter-content {
            color: #e9ecef;
        }
        
        .dark-mode .reader-tools {
            background: rgba(0, 0, 0, 0.8);
            color: #e9ecef;
        }
        
        .dark-mode .reader-tool {
            color: #e9ecef;
        }
        
        .dark-mode .reader-tool:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 2rem 1rem;
            }
            
            .chapter-nav-bottom {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-section.center {
                border: none;
                border-top: 1px solid #e9ecef;
                border-bottom: 1px solid #e9ecef;
                padding: 1rem 0;
            }
            
            .reader-tools {
                position: relative;
                right: auto;
                top: auto;
                transform: none;
                margin: 2rem 0;
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
    <link rel="canonical" href="https://ai-team-orchestrator.com/en/core-philosophy-architecture/agent-environment-interactions/" />
</head>
<body>
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="../../ai-team-orchestrator.html">🏠 AI Team Orchestrator</a>
            <span>›</span>
            <a href="../">🎸 Core Philosophy & Architecture</a>
            <span>›</span>
            <span>The Agent and Its Environment</span>
        </nav>
        
        <header class="chapter-header">
            <div class="chapter-instrument">🎸</div>
            <div class="chapter-meta">
                <span>Movement 1 of 4</span>
                <span>Chapter 6 of 42</span>
                <span>Ready to Read</span>
            </div>
            <h1 class="chapter-title">The Agent and Its Environment – Designing Fundamental Interactions</h1>
        </header>
        
        <div class="chapter-content">
<p>An AI agent, no matter how intelligent, is useless if it can't <strong>perceive and act</strong> on the world around it. Our <code>SpecialistAgent</code> was like a brain in a vat: it could think, but it couldn't read data or write results.</p>

<p>This chapter describes how we built the "arms" and "legs" of our agents: the fundamental interactions with the database, which represented their working environment.</p>

<h3># <strong>The Architectural Decision: A Database as Shared "World State"</strong></h3>

<p>Our first major decision was to use a database (Supabase, in this case) not just as a simple archive, but as the <strong>single source of truth about the "world state"</strong>. Every relevant information for the project – tasks, objectives, deliverables, memory insights – would be stored there.</p>

<p>This approach, known as <strong>"Shared State"</strong> or "Shared Blackboard" (*Blackboard Architecture* in the literature), is a well-documented architectural pattern in multi-agent systems. As described by Hayes-Roth in their seminal work on blackboard systems, this architecture allows independent specialists to collaborate by sharing a common knowledge space, without requiring direct communication between agents.</p>

<p><strong>The Customer Support Team Metaphor</strong></p>

<p>Imagine a customer support team where each specialist (technical, sales, billing) works on different tickets. Instead of constantly emailing each other, they use a shared CRM where everyone can see case status, update notes, and pass tickets to the right colleague. The CRM becomes the team's "shared memory" - if a technician goes on break, another can pick up exactly where they left off, because all the history is centrally documented.</p>

<p>In our system, the Supabase database functions exactly like that CRM: it's the <strong>shared blackboard</strong> where each agent writes its progress and reads that of others. The advantages of this architecture in a multi-agent system are:</p>

<ul>
<li><strong>Implicit Coordination:</strong> Two agents don't need to talk directly to each other. If Agent A completes a task and updates its status to "completed" in the database, Agent B can see this change and start the next task that depended on the first one.</li>
<li><strong>Persistence and Resilience:</strong> If an agent crashes, its work isn't lost. The world state is saved persistently. On restart, another agent (or the same one) can resume exactly where it left off.</li>
<li><strong>Traceability and Audit:</strong> Every action and every state change is recorded. This is fundamental for debugging, performance analysis, and transparency required by our <strong>Pillar #13 (Transparency & Explainability)</strong>.</li>
</ul>

<h3># <strong>Fundamental Interactions: The "Verbs" of Our Agents</strong></h3>

<p>We defined a set of basic interactions, "verbs" that every agent had to be able to perform. For each of these, we created a dedicated function in our <code>database.py</code>, which acted as a <strong>Data Access Layer (DAL)</strong>, another abstraction layer to protect us from Supabase-specific details.</p>

<p><em>Reference code: <code>backend/database.py</code></em></p>

<table>
<thead>
<tr>
<th>Agent Verb</th>
<th>Corresponding DAL Function</th>
<th>Strategic Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Read a Task</strong></td>
<td><code>get_task(task_id)</code></td>
<td>Allows an agent to understand what its current assignment is.</td>
</tr>
<tr>
<td><strong>Update Task Status</strong></td>
<td><code>update_task_status(...)</code></td>
<td>Communicates to the rest of the system that a task is in progress, completed, or failed.</td>
</tr>
<tr>
<td><strong>Create a New Task</strong></td>
<td><code>create_task(...)</code></td>
<td>Allows an agent to delegate or decompose work (essential for planning).</td>
</tr>
<tr>
<td><strong>Save an Insight</strong></td>
<td><code>store_insight(...)</code></td>
<td>The fundamental action for learning. Allows an agent to contribute to collective memory.</td>
</tr>
<tr>
<td><strong>Read Memory</strong></td>
<td><code>get_relevant_context(...)</code></td>
<td>Allows an agent to learn from past experiences before acting.</td>
</tr>
<tr>
<td><strong>Create a Deliverable</strong></td>
<td><code>create_deliverable(...)</code></td>
<td>The final action that produces value for the user.</td>
</tr>
</tbody>
</table>

<h3># <strong>"War Story": The Danger of "Race Conditions" and Pessimistic Locking</strong></h3>

<p>With multiple agents working in parallel, we encountered a classic distributed systems problem: <strong>race conditions</strong>.</p>

<p><em>Disaster Logbook (July 25th):</em></p>

<pre><code class="language-text">WARNING: Agent A started task '123', but Agent B had already started it 50ms earlier.
ERROR: Duplicate entry for key 'PRIMARY' on table 'goal_progress_logs'.</code></pre>

<p><strong>What was happening?</strong> Two agents, seeing the same "pending" task in the database, tried to take it on simultaneously. Both updated it to "in_progress", and both, once finished, tried to update the progress of the same objective, causing a conflict.</p>

<p>The solution was to implement a form of <strong>"Pessimistic Locking" at the application level</strong>.</p>

<p><strong>Task Acquisition Flow (Correct):</strong></p>

<div class="architecture-section">
    <div class="architecture-title">
        <svg class="architecture-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <line x1="9" y1="9" x2="15" y2="9"/>
            <line x1="9" y1="12" x2="15" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
        </svg>
        <h4>System Architecture</h4>
    </div>
    
    <div class="mermaid">
        graph TD
            A[Free Agent] --> B{Search for 'pending' Tasks} 
            B --> C{Find Task '123'} 
            C --> D[Atomic Action: Try to update status to 'in_progress' CONDITIONALLY] 
            D -- Success: Only 1 agent can win --> E[Start Task Execution] 
            D -- Failure: Another agent was faster --> B
    </div>
</div>

<p><strong>The Code Implementation (Simplified):</strong></p>

<p><em>Reference code: <code>backend/database.py</code></em></p>

<pre><code class="language-python">def try_claim_task(agent_id: str, task_id: str) -> bool:
    """
    Tries to claim a task atomically. Returns True if successful, False if another agent claimed it first.
    """
    try:
        # This UPDATE query only succeeds if the task is still 'pending'
        result = supabase.table('tasks').update({
            'status': 'in_progress',
            'assigned_agent_id': agent_id,
            'started_at': datetime.utcnow().isoformat()
        }).eq('id', task_id).eq('status', 'pending').execute()
        
        # If no rows were affected, another agent already claimed the task
        return len(result.data) > 0
        
    except Exception as e:
        logger.error(f"Error claiming task {task_id}: {e}")
        return False</code></pre>

<p>This simple conditional update ensured that only one agent could claim a task, eliminating race conditions and duplicate work.</p>

<h3># <strong>The Evolution of Database Schema: From Simple to Sophisticated</strong></h3>

<p>As our agents became more capable, our database schema had to evolve to support increasingly complex interactions.</p>

<div class="war-story-section">
    <div class="war-story-header">
        <div class="war-story-icon">⚡</div>
        <h4>War Story: Schema Evolution</h4>
    </div>
    <div class="war-story-content">
        <p><strong>Phase 1: Basic Task Management</strong><br>
        We started with simple tables: <code>tasks</code>, <code>agents</code>, <code>workspaces</code>. Basic CRUD operations.</p>
        
        <p><strong>Phase 2: Memory Integration</strong><br>
        We added <code>memory_insights</code>, <code>context_embeddings</code> tables. Agents could now learn and remember.</p>
        
        <p><strong>Phase 3: Quality Gates</strong><br>
        We introduced <code>quality_checks</code>, <code>human_feedback</code>. Every deliverable had to pass validation.</p>
        
        <p><strong>Phase 4: Advanced Orchestration</strong><br>
        Finally: <code>goal_progress_logs</code>, <code>agent_handoffs</code>, <code>deliverable_assets</code>. A complete ecosystem.</p>
    </div>
</div>

<p>Each phase required us to maintain backward compatibility while adding new capabilities. The DAL pattern proved invaluable here: changes to the database schema required updates only to our <code>database.py</code> file, not to every agent.</p>

<h3># <strong>The Lesson Learned: Treat Your Database as a Communication Protocol</strong></h3>

<p>The most important insight from this phase was changing our mental model. We stopped thinking of the database as a mere "storage" and started treating it as a <strong>communication protocol between agents</strong>.</p>

<p>Every table became a "channel":</p>
<ul>
<li><strong>The <code>tasks</code> table was the "work queue"</strong> – agents published work here and claimed assignments.</li>
<li><strong>The <code>memory_insights</code> table was the "knowledge sharing channel"</strong> – agents contributed learnings for others to benefit from.</li>
<li><strong>The <code>goal_progress_logs</code> table was the "coordination channel"</strong> – agents announced progress and celebrated achievements.</li>
</ul>

<p>This paradigm shift from "storage-centric" to "communication-centric" was fundamental to scaling our system. Instead of requiring complex inter-agent communication protocols, we had a simple, reliable, and auditable message-passing system.</p>

<div class="key-takeaways-section">
    <h4 class="key-takeaways-title">📝 Chapter Key Takeaways:</h4>
    <div class="key-takeaways-content">
<p class="takeaway-item">✓ <strong>Design for Concurrency from Day One:</strong> Multi-agent systems will have race conditions. Plan for them with atomic operations and proper locking.</p>
<p class="takeaway-item">✓ <strong>Use a Data Access Layer (DAL):</strong> Never let your agents talk directly to the database. Abstract all interactions through a dedicated service layer.</p>
<p class="takeaway-item">✓ <strong>Database as Communication Protocol:</strong> In a multi-agent system, your database isn't just storage – it's the nervous system enabling coordination.</p>
<p class="takeaway-item">✓ <strong>Plan for Schema Evolution:</strong> Your data needs will grow more complex. Design your abstractions to handle schema changes gracefully.</p>
    </div>
</div>

<p><strong>Chapter Conclusion</strong></p>

<p>With a robust database interaction layer, our agents finally had "hands" to manipulate their environment. They could read tasks, update progress, create new work, and share knowledge. We had built the foundation for true collaboration.</p>

<p>But having capable individual agents wasn't enough. We needed someone to conduct the orchestra, to ensure the right agent got the right task at the right time. This brought us to our next challenge: building the <strong>Orchestrator</strong>, the brain that would coordinate our entire AI team.</p>
        </div>
        
        <!-- Bottom Navigation -->
        <nav class="chapter-nav-bottom">
            <div class="nav-section">
                <div class="nav-label">← Previous Chapter</div>
                <a href="../first-specialist-agent-architecture/" class="nav-link nav-prev">
                    First Specialist Agent Architecture
                </a>
            </div>
            <div class="nav-section center">
                <a href="../" class="nav-link nav-home">📚 Movement Overview</a>
            </div>
            <div class="nav-section">
                <div class="nav-label">Next Chapter →</div>
                <a href="../orchestrator-conductor/" class="nav-link nav-next">
                    The Orchestrator – The Conductor
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Reader Tools -->
    <div class="reader-tools" id="readerTools">
        <div class="reader-tool" onclick="toggleTheme()">
            <span class="reader-tool-icon" id="themeIcon">🌙</span>
            <span class="reader-tool-label">Theme</span>
        </div>
        
        <div class="reader-tool" onclick="toggleBookmark()">
            <span class="reader-tool-icon">🔖</span>
            <span class="reader-tool-label">Bookmark</span>
        </div>
        
        <div class="reader-tool" onclick="showBookmarks()">
            <span class="reader-tool-icon">📚</span>
            <span class="reader-tool-label">My Bookmarks</span>
        </div>
        
        <div class="language-switcher">
            <select class="language-select" onchange="switchLanguage(this.value)">
                <option value="en">🇬🇧 EN</option>
                <option value="it">🇮🇹 IT</option>
            </select>
        </div>
        
        <div class="reader-tool" onclick="showFontSizeMenu()">
            <span class="reader-tool-icon">🔤</span>
            <span class="reader-tool-label">Font Size</span>
        </div>
    </div>
    
    <!-- Reading Progress -->
    <div class="reading-progress">
        <div class="reading-progress-fill" id="progressFill"></div>
    </div>
    
    <!-- Bookmark Toast -->
    <div class="bookmark-toast" id="bookmarkToast">
        <span id="bookmarkMessage">Bookmark saved!</span>
    </div>
    
    <script>
        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const isDarkMode = body.classList.contains('dark-mode');
            
            if (isDarkMode) {
                body.classList.remove('dark-mode');
                if (themeIcon) themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                if (themeIcon) themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Bookmark functionality
        function toggleBookmark() {
            const currentPage = window.location.pathname;
            const pageTitle = document.querySelector('.chapter-title')?.textContent || 'Chapter';
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            const existingIndex = bookmarks.findIndex(b => b.url === currentPage);
            
            if (existingIndex > -1) {
                bookmarks.splice(existingIndex, 1);
                showToast('Bookmark removed!', 'error');
            } else {
                bookmarks.push({
                    url: currentPage,
                    title: pageTitle,
                    timestamp: new Date().toISOString()
                });
                showToast('Bookmark saved!', 'success');
            }
            
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        }
        
        // Language switching
        function switchLanguage(lang) {
            const currentPath = window.location.pathname;
            let newPath;
            
            if (lang === 'it') {
                newPath = currentPath.replace('/en/', '/it/')
                    .replace('core-philosophy-architecture', 'filosofia-core-architettura')
                    .replace('agent-environment-interactions', 'agente-ambiente-interazioni-fondamentali');
            }
            
            if (newPath && newPath !== currentPath) {
                window.location.href = newPath;
            }
        }
        
        // Font size menu
        function showFontSizeMenu() {
            const currentSize = localStorage.getItem('fontSize') || 'medium';
            let newSize;
            
            switch (currentSize) {
                case 'small':
                    newSize = 'medium';
                    break;
                case 'medium':
                    newSize = 'large';
                    break;
                case 'large':
                    newSize = 'small';
                    break;
                default:
                    newSize = 'medium';
            }
            
            setFontSize(newSize);
            localStorage.setItem('fontSize', newSize);
            showToast(`Font size: ${newSize}`, 'success');
        }
        
        // Set font size
        function setFontSize(size) {
            const root = document.documentElement;
            const sizes = {
                'small': '0.9',
                'medium': '1.0',
                'large': '1.1'
            };
            root.style.fontSize = sizes[size] + 'em';
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('bookmarkToast');
            const messageEl = document.getElementById('bookmarkMessage');
            
            if (!toast || !messageEl) return;
            
            messageEl.textContent = message;
            toast.classList.remove('show', 'error');
            
            if (type === 'error') {
                toast.classList.add('error');
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Reading progress
        function updateReadingProgress() {
            const progressFill = document.getElementById('progressFill');
            
            window.addEventListener('scroll', () => {
                const article = document.querySelector('.chapter-content');
                if (!article) return;
                
                const articleTop = article.offsetTop;
                const articleHeight = article.offsetHeight;
                const windowHeight = window.innerHeight;
                const scrollTop = window.pageYOffset;
                
                const progress = Math.min(100, Math.max(0, 
                    ((scrollTop + windowHeight - articleTop) / articleHeight) * 100
                ));
                
                progressFill.style.width = progress + '%';
            });
        }
        
        // Load user preferences
        function loadUserPreferences() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) themeIcon.textContent = '☀️';
            }
            
            const savedFontSize = localStorage.getItem('fontSize') || 'medium';
            setFontSize(savedFontSize);
        }
        
        function showBookmarks() {
            createBookmarksModal();
            const modal = document.getElementById('bookmarksModal')
            const bookmarksList = document.getElementById('bookmarksList')
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = `
                    <div class="no-bookmarks">
                        <div class="no-bookmarks-icon">📚</div>
                        <h3>No bookmarks saved</h3>
                        <p>Start saving your favorite chapters by clicking the 🔖 icon</p>
                    </div>`;
            } else {
                bookmarksList.innerHTML = bookmarks
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .map(bookmark => `
                        <div class="bookmark-item">
                            <div class="bookmark-info">
                                <div class="bookmark-title">${bookmark.title}</div>
                                <a href="${bookmark.url}" class="bookmark-url">${bookmark.url}</a>
                                <div class="bookmark-date">Saved ${new Date(bookmark.timestamp).toLocaleDateString()}</div>
                            </div>
                            <div class="bookmark-actions">
                                <button class="bookmark-action delete" onclick="deleteBookmark('${bookmark.url}')">🗑️</button>
                            </div>
                        </div>
                    `).join('');
            }
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeBookmarksModal(event) {
            const modal = document.getElementById('bookmarksModal')
            if (modal && (!event || event.target === modal)) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function deleteBookmark(url) {
            let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            bookmarks = bookmarks.filter(b => b.url !== url);
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            showToast('Bookmark removed!', 'error');
            showBookmarks();
        }
        
        function createBookmarksModal() {
            if (document.getElementById('bookmarksModal')) return;
            
            const modal = document.createElement('div');
            modal.id = 'bookmarksModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: none;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f1f3f4;">
                        <h2 style="margin: 0; color: #2c3e50;">📚 My Bookmarks</h2>
                        <button onclick="closeBookmarksModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #adb5bd;">✕</button>
                    </div>
                    <div id="bookmarksList"></div>
                </div>`;
            
            modal.onclick = closeBookmarksModal;
            document.body.appendChild(modal);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateReadingProgress();
            loadUserPreferences();
        });
    </script>
</body>
</html>
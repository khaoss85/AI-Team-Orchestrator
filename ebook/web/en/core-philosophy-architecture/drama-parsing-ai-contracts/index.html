<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Parsing Drama and Birth of the "AI Contract" | Core Philosophy Architecture | AI Team Orchestrator</title>
    <meta name="description" content="Chapter 4 of AI Team Orchestrator: The Parsing Drama and Birth of the AI Contract">
    <meta name="robots" content="index, follow">

    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🤖</text></svg>">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .chapter-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .chapter-instrument {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .chapter-meta {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            flex-wrap: wrap;
        }
        
        .chapter-title {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .chapter-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #34495e;
        }
        
        .chapter-content h3 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin: 2.5rem 0 1.5rem 0;
            font-weight: 700;
        }
        
        .chapter-content h4 {
            font-size: 1.4rem;
            color: #2c3e50;
            margin: 2rem 0 1rem 0;
            font-weight: 600;
        }
        
        .chapter-content p {
            margin-bottom: 1.5rem;
        }
        
        .chapter-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }
        
        .chapter-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }
        
        .chapter-content pre code {
            background: none;
            padding: 0;
            color: #212529;
        }
        
        .chapter-content ul, .chapter-content ol {
            margin: 1.5rem 0;
            padding-left: 2rem;
        }
        
        .chapter-content li {
            margin-bottom: 0.5rem;
        }
        
        .key-takeaways-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
        }
        
        .key-takeaways-title {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }
        
        .takeaway-item {
            margin: 1rem 0;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .takeaway-item:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #4ade80;
            font-weight: bold;
        }
        
        .architecture-section {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            border-left: 4px solid #0277bd;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }
        
        .architecture-title {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .architecture-icon {
            width: 24px;
            height: 24px;
            margin-right: 0.5rem;
            color: #0277bd;
        }
        
        .architecture-title h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: #0277bd;
        }
        
        .mermaid {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .breadcrumb {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb span {
            color: #7f8c8d;
            margin: 0 0.5rem;
        }
        
        .chapter-nav-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            gap: 2rem;
        }
        
        .nav-section {
            flex: 1;
            text-align: center;
        }
        
        .nav-section.center {
            border-left: 1px solid #e9ecef;
            border-right: 1px solid #e9ecef;
        }
        
        .nav-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }
        
        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: inline-block;
        }
        
        .nav-link:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Reader Tools */
        .reader-tools {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            transition: all 0.3s ease;
            min-width: 60px;
        }
        
        .reader-tool {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #667eea;
            font-weight: 500;
        }
        
        .reader-tool:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .reader-tool-icon {
            font-size: 1.2rem;
            min-width: 20px;
        }
        
        .reader-tool-label {
            font-size: 0.9rem;
        }
        
        .language-select {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.5rem;
            color: #667eea;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .language-select:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        /* Reading Progress */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(102, 126, 234, 0.2);
            z-index: 1001;
        }
        
        .reading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.2s ease;
            width: 0%;
        }
        
        /* Bookmark Toast */
        .bookmark-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4ade80;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1002;
        }
        
        .bookmark-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .bookmark-toast.error {
            background: #ef4444;
        }
        
        /* Bookmark Modal Styles */
        .no-bookmarks {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }
        
        .no-bookmarks-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .no-bookmarks h3 {
            color: #2c3e50;
            margin: 1rem 0 0.5rem 0;
        }
        
        .bookmark-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.2s ease;
        }
        
        .bookmark-item:hover {
            background: #f8f9fa;
        }
        
        .bookmark-info {
            flex: 1;
        }
        
        .bookmark-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .bookmark-url {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .bookmark-url:hover {
            text-decoration: underline;
        }
        
        .bookmark-date {
            font-size: 0.8rem;
            color: #adb5bd;
        }
        
        .bookmark-actions {
            margin-left: 1rem;
        }
        
        .bookmark-action {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .bookmark-action:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* Dark Mode */
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e9ecef;
        }
        
        .dark-mode .container {
            background: rgba(26, 26, 46, 0.95);
            color: #e9ecef;
        }
        
        .dark-mode .chapter-title,
        .dark-mode .chapter-content h3,
        .dark-mode .chapter-content h4 {
            color: #e9ecef;
        }
        
        .dark-mode .chapter-content {
            color: #e9ecef;
        }
        
        .dark-mode .reader-tools {
            background: rgba(0, 0, 0, 0.8);
            color: #e9ecef;
        }
        
        .dark-mode .reader-tool {
            color: #e9ecef;
        }
        
        .dark-mode .reader-tool:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 2rem 1rem;
            }
            
            .chapter-nav-bottom {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-section.center {
                border: none;
                border-top: 1px solid #e9ecef;
                border-bottom: 1px solid #e9ecef;
                padding: 1rem 0;
            }
            
            .reader-tools {
                position: relative;
                right: auto;
                top: auto;
                transform: none;
                margin: 2rem 0;
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
    <link rel="canonical" href="https://ai-team-orchestrator.com/en/core-philosophy-architecture/drama-parsing-ai-contracts/" />
</head>
<body>
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="../../ai-team-orchestrator.html">🏠 AI Team Orchestrator</a>
            <span>›</span>
            <a href="../">🎺 Core Philosophy & Architecture</a>
            <span>›</span>
            <span>The Parsing Drama and AI Contracts</span>
        </nav>
        
        <header class="chapter-header">
            <div class="chapter-instrument">🎺</div>
            <div class="chapter-meta">
                <span>Movement 1 of 4</span>
                <span>Chapter 4 of 42</span>
                <span>Ready to Read</span>
            </div>
            <h1 class="chapter-title">The Parsing Drama and Birth of the "AI Contract"</h1>
        </header>
        
        <div class="chapter-content">
<p>We had a testable agent and a robust test environment. We were ready to start building real business functionality. Our first goal was simple: have an agent, given an objective, decompose it into a list of structured tasks.</p>

<p>It seemed easy. The prompt was clear, the agent responded. But when we tried to use the output, the system started failing in unpredictable and frustrating ways. Welcome to the <strong>Parsing Drama</strong>.</p>

<h3># <strong>The Problem: The Illusion of Structure</strong></h3>

<p>Asking an LLM to respond in JSON format is a common practice. The problem is that an LLM <strong>doesn't generate JSON, it generates text that <em>looks like</em> JSON</strong>. This subtle difference is the source of countless bugs and sleepless nights.</p>

<p><strong>Real Examples of JSON Parsing Errors from Our Logs</strong></p>

<p>Our logs revealed common parsing issues. Here are some real examples we faced:</p>

<ul>
<li><strong>The Treacherous Comma (Trailing Comma):</strong>
<pre><code class="language-text">ERROR: json.decoder.JSONDecodeError: Trailing comma: line 8 column 2 (char 123)
    {"tasks": [{"name": "Task 1"}, {"name": "Task 2"},]}
</code></pre></li>

<li><strong>The Rebellious Apostrophe (Single Quotes):</strong>
<pre><code class="language-text">ERROR: json.decoder.JSONDecodeError: Expecting property name enclosed in double quotes
    {'tasks': [{'name': 'Task 1'}]}
</code></pre></li>

<li><strong>The Structural Hallucination:</strong>
<pre><code class="language-text">"Certainly, here's the JSON you requested:
[
    {"task": "Market analysis"}
]
I hope this helps with your project!"
</code></pre></li>

<li><strong>The Silent Failure (The Null Response):</strong>
<pre><code class="language-text">ERROR: 'NoneType' object is not iterable
# The AI, not knowing what to respond, returned 'null'.
</code></pre></li>
</ul>

<p>These weren't isolated cases; they were the norm. We realized we couldn't build a reliable system if our communication layer with the AI was so fragile.</p>

<h4># <strong>The Architectural Solution: An "Immune System" for AI Input</strong></h4>

<p>We stopped considering these errors as bugs to fix one by one. We saw them as a systemic problem that required an architectural solution: an <strong>"Anti-Corruption Layer"</strong> to protect our system from AI unpredictability.</p>

<p>This solution is based on two components working in tandem:</p>

<p><strong>Phase 1: The Output "Sanitizer" (<code>IntelligentJsonParser</code>)</strong></p>

<p>We created a dedicated service not just to parse, but to <strong>isolate, clean, and correct</strong> the raw LLM output.</p>

<p><em>Reference code: <code>backend/utils/json_parser.py</code> (hypothetical)</em></p>

<pre><code class="language-python">import re
import json

class IntelligentJsonParser:
    
    def extract_and_parse(self, raw_text: str) -> dict:
        """
        Extracts, cleans, and parses a JSON block from a text string.
        """
        try:
            # 1. Extraction: Find the JSON block, ignoring surrounding text.
            json_match = re.search(r'\{.*\}|\[.*\]', raw_text, re.DOTALL)
            if not json_match:
                raise ValueError("No JSON block found in text.")
            
            json_string = json_match.group(0)
            
            # 2. Cleaning: Remove common errors like trailing commas.
            # (This is a simplification; the real logic is more complex)
            json_string = re.sub(r',\s*([\}\]])', r'\1', json_string)
            
            # 3. Parsing: Convert the clean string to a Python object.
            return json.loads(json_string)
            
        except Exception as e:
            logger.error(f"Parsing failed: {e}")
            # Here could start a "retry" logic
            raise
</code></pre>

<p><strong>Phase 2: The Pydantic "Data Contract"</strong></p>

<p>Once we obtained a syntactically valid JSON, we needed to guarantee its <strong>semantic validity</strong>. Were the structure and data types correct? For this, we used Pydantic as an inflexible "contract".</p>

<p><em>Reference code: <code>backend/models.py</code></em></p>

<pre><code class="language-python">from pydantic import BaseModel, Field
from typing import List, Literal

class SubTask(BaseModel):
    task_name: str = Field(..., description="The name of the sub-task.")
    description: str
    priority: Literal["low", "medium", "high"]

class TaskDecomposition(BaseModel):
    tasks: List[SubTask]
    reasoning: str
</code></pre>

<p>Any JSON that didn't respect exactly this structure was discarded, generating a controlled error instead of an unpredictable downstream crash.</p>

<p><strong>Complete Validation Flow:</strong></p>

<div class="architecture-section">
    <div class="architecture-title">
        <svg class="architecture-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <line x1="9" y1="9" x2="15" y2="9"/>
            <line x1="9" y1="12" x2="15" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
        </svg>
        <h4>System Architecture</h4>
    </div>
    
    <div class="mermaid">
        graph TD
            A[Raw LLM Output] --> B{Phase 1: Sanitizer}
            B -- Regex to extract JSON --> C[Clean JSON String]
            C --> D{Phase 2: Pydantic Contract}
            D -- Validated data --> E[Safe TaskDecomposition Object]
            B -- Extraction Failure --> F{Managed Error}
            D -- Invalid data --> F
            F --> G[Log Error / Trigger Retry]
            E --> H[System Usage]
    </div>
</div>

<h3># <strong>The Lesson Learned: AI is a Collaborator, not a Compiler</strong></h3>

<p>This experience radically changed our way of interacting with LLMs and reinforced several of our pillars:</p>

<ul>
<li><strong>Pillar #10 (Production-Ready):</strong> A system isn't production-ready if it doesn't have defense mechanisms against unreliable input. Our parser became part of our "immune system".</li>
<li><strong>Pillar #14 (Modular Service-Layer):</strong> Instead of scattering parsing <code>try-except</code> logic throughout the code, we created a centralized and reusable service.</li>
<li><strong>Pillar #2 (AI-Driven):</strong> Paradoxically, by creating these rigid validation barriers, we made our system <em>more</em> AI-Driven. We could now delegate increasingly complex tasks to AI, knowing we had a safety net capable of handling its imperfect outputs.</li>
</ul>

<p>We learned to treat AI as an <strong>incredibly talented but sometimes distracted collaborator</strong>. Our job as engineers isn't just to "ask", but also to "verify, validate, and, if necessary, correct" its work.</p>

<div class="key-takeaways-section">
    <h4 class="key-takeaways-title">📝 Chapter Key Takeaways:</h4>
    <div class="key-takeaways-content">
<p class="takeaway-item">✓ <strong>Never trust LLM output.</strong> Always treat it as unreliable user input.</p>
<p class="takeaway-item">✓ <strong>Separate parsing from validation.</strong> First get syntactically correct JSON, then validate its structure and types with a model (like Pydantic).</p>
<p class="takeaway-item">✓ <strong>Centralize parsing logic.</strong> Create a dedicated service instead of repeating error handling logic throughout the codebase.</p>
<p class="takeaway-item">✓ <strong>A robust system allows greater AI delegation.</strong> The stronger your barriers, the more you can afford to entrust complex tasks to artificial intelligence.</p>
    </div>
</div>

<p><strong>Chapter Conclusion</strong></p>

<p>With a reliable parsing and validation system, we finally had a way to give complex instructions to AI and receive structured data we could rely on in return. We had transformed AI output from a source of bugs into a reliable resource.</p>

<p>But having reliable communication with individual agents wasn't enough. We needed to understand how to design agents themselves, with clear roles, responsibilities, and boundaries. This brought us to our next challenge: architecting our first <strong>Specialist Agent</strong>.</p>
        </div>
        
        <!-- Bottom Navigation -->
        <nav class="chapter-nav-bottom">
            <div class="nav-section">
                <div class="nav-label">← Previous Chapter</div>
                <a href="../ai-mocking-testing-strategy/" class="nav-link nav-prev">
                    AI Mocking Testing Strategy
                </a>
            </div>
            <div class="nav-section center">
                <a href="../" class="nav-link nav-home">📚 Movement Overview</a>
            </div>
            <div class="nav-section">
                <div class="nav-label">Next Chapter →</div>
                <a href="../first-specialist-agent-architecture/" class="nav-link nav-next">
                    First Specialist Agent Architecture
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Reader Tools -->
    <div class="reader-tools" id="readerTools">
        <div class="reader-tool" onclick="toggleTheme()">
            <span class="reader-tool-icon" id="themeIcon">🌙</span>
            <span class="reader-tool-label">Theme</span>
        </div>
        
        <div class="reader-tool" onclick="toggleBookmark()">
            <span class="reader-tool-icon">🔖</span>
            <span class="reader-tool-label">Bookmark</span>
        </div>
        
        <div class="reader-tool" onclick="showBookmarks()">
            <span class="reader-tool-icon">📚</span>
            <span class="reader-tool-label">My Bookmarks</span>
        </div>
        
        <div class="language-switcher">
            <select class="language-select" onchange="switchLanguage(this.value)">
                <option value="en">🇬🇧 EN</option>
                <option value="it">🇮🇹 IT</option>
            </select>
        </div>
        
        <div class="reader-tool" onclick="showFontSizeMenu()">
            <span class="reader-tool-icon">🔤</span>
            <span class="reader-tool-label">Font Size</span>
        </div>
    </div>
    
    <!-- Reading Progress -->
    <div class="reading-progress">
        <div class="reading-progress-fill" id="progressFill"></div>
    </div>
    
    <!-- Bookmark Toast -->
    <div class="bookmark-toast" id="bookmarkToast">
        <span id="bookmarkMessage">Bookmark saved!</span>
    </div>
    
    <script>
        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const isDarkMode = body.classList.contains('dark-mode');
            
            if (isDarkMode) {
                body.classList.remove('dark-mode');
                if (themeIcon) themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                if (themeIcon) themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Bookmark functionality
        function toggleBookmark() {
            const currentPage = window.location.pathname;
            const pageTitle = document.querySelector('.chapter-title')?.textContent || 'Chapter';
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            const existingIndex = bookmarks.findIndex(b => b.url === currentPage);
            
            if (existingIndex > -1) {
                bookmarks.splice(existingIndex, 1);
                showToast('Bookmark removed!', 'error');
            } else {
                bookmarks.push({
                    url: currentPage,
                    title: pageTitle,
                    timestamp: new Date().toISOString()
                });
                showToast('Bookmark saved!', 'success');
            }
            
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        }
        
        // Language switching
        function switchLanguage(lang) {
            const currentPath = window.location.pathname;
            let newPath;
            
            if (lang === 'it') {
                newPath = currentPath.replace('/en/', '/it/')
                    .replace('core-philosophy-architecture', 'filosofia-core-architettura')
                    .replace('drama-parsing-ai-contracts', 'dramma-parsing-contratto-ai');
            }
            
            if (newPath && newPath !== currentPath) {
                window.location.href = newPath;
            }
        }
        
        // Font size menu
        function showFontSizeMenu() {
            const currentSize = localStorage.getItem('fontSize') || 'medium';
            let newSize;
            
            switch (currentSize) {
                case 'small':
                    newSize = 'medium';
                    break;
                case 'medium':
                    newSize = 'large';
                    break;
                case 'large':
                    newSize = 'small';
                    break;
                default:
                    newSize = 'medium';
            }
            
            setFontSize(newSize);
            localStorage.setItem('fontSize', newSize);
            showToast(`Font size: ${newSize}`, 'success');
        }
        
        // Set font size
        function setFontSize(size) {
            const root = document.documentElement;
            const sizes = {
                'small': '0.9',
                'medium': '1.0',
                'large': '1.1'
            };
            root.style.fontSize = sizes[size] + 'em';
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('bookmarkToast');
            const messageEl = document.getElementById('bookmarkMessage');
            
            if (!toast || !messageEl) return;
            
            messageEl.textContent = message;
            toast.classList.remove('show', 'error');
            
            if (type === 'error') {
                toast.classList.add('error');
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Reading progress
        function updateReadingProgress() {
            const progressFill = document.getElementById('progressFill');
            
            window.addEventListener('scroll', () => {
                const article = document.querySelector('.chapter-content');
                if (!article) return;
                
                const articleTop = article.offsetTop;
                const articleHeight = article.offsetHeight;
                const windowHeight = window.innerHeight;
                const scrollTop = window.pageYOffset;
                
                const progress = Math.min(100, Math.max(0, 
                    ((scrollTop + windowHeight - articleTop) / articleHeight) * 100
                ));
                
                progressFill.style.width = progress + '%';
            });
        }
        
        // Load user preferences
        function loadUserPreferences() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) themeIcon.textContent = '☀️';
            }
            
            const savedFontSize = localStorage.getItem('fontSize') || 'medium';
            setFontSize(savedFontSize);
        }
        
        function showBookmarks() {
            createBookmarksModal();
            const modal = document.getElementById('bookmarksModal')
            const bookmarksList = document.getElementById('bookmarksList')
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = `
                    <div class="no-bookmarks">
                        <div class="no-bookmarks-icon">📚</div>
                        <h3>No bookmarks saved</h3>
                        <p>Start saving your favorite chapters by clicking the 🔖 icon</p>
                    </div>`;
            } else {
                bookmarksList.innerHTML = bookmarks
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .map(bookmark => `
                        <div class="bookmark-item">
                            <div class="bookmark-info">
                                <div class="bookmark-title">${bookmark.title}</div>
                                <a href="${bookmark.url}" class="bookmark-url">${bookmark.url}</a>
                                <div class="bookmark-date">Saved ${new Date(bookmark.timestamp).toLocaleDateString()}</div>
                            </div>
                            <div class="bookmark-actions">
                                <button class="bookmark-action delete" onclick="deleteBookmark('${bookmark.url}')">🗑️</button>
                            </div>
                        </div>
                    `).join('');
            }
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeBookmarksModal(event) {
            const modal = document.getElementById('bookmarksModal')
            if (modal && (!event || event.target === modal)) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        function deleteBookmark(url) {
            let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            bookmarks = bookmarks.filter(b => b.url !== url);
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            showToast('Bookmark removed!', 'error');
            showBookmarks();
        }
        
        function createBookmarksModal() {
            if (document.getElementById('bookmarksModal')) return;
            
            const modal = document.createElement('div');
            modal.id = 'bookmarksModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: none;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f1f3f4;">
                        <h2 style="margin: 0; color: #2c3e50;">📚 My Bookmarks</h2>
                        <button onclick="closeBookmarksModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #adb5bd;">✕</button>
                    </div>
                    <div id="bookmarksList"></div>
                </div>`;
            
            modal.onclick = closeBookmarksModal;
            document.body.appendChild(modal);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateReadingProgress();
            loadUserPreferences();
        });
    </script>
</body>
</html>